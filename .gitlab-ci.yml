default:
  tags: [shell]

variables:
  HOST: $CI_PROJECT_PATH_SLUG-$CI_COMMIT_REF_SLUG.$BASE_DOMAIN
  NAMESPACE: $CI_PROJECT_PATH_SLUG-$CI_COMMIT_REF_SLUG

deploy:
  script:
    - helm upgrade --install hello --repo https://helm.sikalabs.io hello-world --namespace $NAMESPACE --create-namespace --set host=$HOST --set TEXT="$CI_COMMIT_REF_NAME" --set replicas=4
  environment:
    name: $CI_COMMIT_REF_SLUG
    url: https://$HOST
    on_stop: stop

stop:
  variables:
    GIT_STRATEGY: none
  script: helm uninstall hello --namespace $NAMESPACE
  when: manual
  allow_failure: false
  environment:
    name: $CI_COMMIT_REF_SLUG
    action: stop
